# üîç –ì–õ–£–ë–ò–ù–ù–´–ô –ê–ù–ê–õ–ò–ó FSM AGENDA –ü–†–û–ë–õ–ï–ú–´

## üö® –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

**–°–∏–º–ø—Ç–æ–º:** –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ `/agenda` ‚Üí "–ø–æ –ª—é–¥—è–º" ‚Üí –≤–≤–æ–¥ –∏–º–µ–Ω–∏ —á–µ–ª–æ–≤–µ–∫–∞ —Ç–µ–∫—Å—Ç–æ–º (–Ω–µ –∫–Ω–æ–ø–∫–æ–π), –±–æ—Ç –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–µ–∫—Å—Ç –∫–∞–∫ –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—é –≤–º–µ—Å—Ç–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–∞–∫ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –ø–æ–≤–µ—Å—Ç–∫–∞.

**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:** –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π –ø–æ–≤–µ—Å—Ç–∫–∏  
**–§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:** –ó–∞–ø—Ä–æ—Å "–í—ã–±–µ—Ä–∏ —à–∞–±–ª–æ–Ω —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏"

## üî¨ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### **1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ FSM –≤ aiogram**

```python
# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π
class AgendaStates(StatesGroup):
    waiting_meeting_id = State()
    waiting_person_name = State()  # –ü—Ä–æ–±–ª–µ–º–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    waiting_tag_name = State()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤ handlers_agenda.py
@router.message(AgendaStates.waiting_person_name, F.text)
async def handle_person_name_input(message: Message, state: FSMContext):
    # –î–æ–ª–∂–µ–Ω –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –≤ —ç—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
```

### **2. –ü–æ—Ä—è–¥–æ–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–æ—É—Ç–µ—Ä–æ–≤**

```python
# –í main.py:
dp.include_router(agenda_router)      # –ü–ï–†–í–´–ô - –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
dp.include_router(tags_review_router) 
dp.include_router(direct_commit_router)
dp.include_router(people_router)
dp.include_router(llm_commit_router)
dp.include_router(queries_router)
dp.include_router(inline_router)
dp.include_router(admin_router)
dp.include_router(admin_monitoring_router)
dp.include_router(router)             # –ü–û–°–õ–ï–î–ù–ò–ô - –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–æ—É—Ç–µ—Ä
```

### **3. –ö–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã**

```python
# –í handlers_agenda.py (—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π):
@router.message(AgendaStates.waiting_person_name, F.text)

# –í handlers.py (—à–∏—Ä–æ–∫–∏–π):
@router.message(F.text & ~F.text.startswith("/"))
```

## üîç –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã

### **–ì–∏–ø–æ—Ç–µ–∑–∞ 1: –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤ aiogram**
**–û–ø–∏—Å–∞–Ω–∏–µ:** aiogram –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –Ω–µ –≤ –ø–æ—Ä—è–¥–∫–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–æ—É—Ç–µ—Ä–æ–≤, –∞ –ø–æ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ—Å—Ç–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤.

**–ê–Ω–∞–ª–∏–∑:**
- –§–∏–ª—å—Ç—Ä `F.text & ~F.text.startswith("/")` –æ—á–µ–Ω—å —à–∏—Ä–æ–∫–∏–π
- –§–∏–ª—å—Ç—Ä `AgendaStates.waiting_person_name, F.text` –±–æ–ª–µ–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π
- –í–æ–∑–º–æ–∂–Ω–æ, aiogram –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

**–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã:**
- ‚úÖ –¢–µ—Å—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —á—Ç–æ –∑–∞—â–∏—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
- ‚úÖ Warning "Agenda state reached main handler" –ø–æ—è–≤–ª—è–µ—Ç—Å—è
- ‚ùå –ù–æ agenda –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è

### **–ì–∏–ø–æ—Ç–µ–∑–∞ 2: –ü—Ä–æ–±–ª–µ–º–∞ —Å MemoryStorage**
**–û–ø–∏—Å–∞–Ω–∏–µ:** FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–æ–≥—É—Ç –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤ MemoryStorage –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏.

**–ê–Ω–∞–ª–∏–∑:**
```python
# –í main.py:
bot, dp = build_bot(TELEGRAM_TOKEN, MemoryStorage())
```

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –º–µ–∂–¥—É callback –∏ text message
- Race conditions –≤ MemoryStorage
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

**–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã:**
- ‚ùì –ù–µ—Ç –ª–æ–≥–æ–≤ –æ –ø–æ—Ç–µ—Ä–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- ‚ùì –ù–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ—Ö–æ–¥–∏—Ç –¥–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞

### **–ì–∏–ø–æ—Ç–µ–∑–∞ 3: Timing/Race condition**
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ú–µ–∂–¥—É —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π —Å–æ—Å—Ç–æ—è–Ω–∏—è (callback) –∏ –≤–≤–æ–¥–æ–º —Ç–µ–∫—Å—Ç–∞ –º–æ–∂–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å race condition.

**–ê–Ω–∞–ª–∏–∑:**
- Callback —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `AgendaStates.waiting_person_name`
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—ã—Å—Ç—Ä–æ –≤–≤–æ–¥–∏—Ç —Ç–µ–∫—Å—Ç
- –°–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–∂–µ—Ç –Ω–µ —É—Å–ø–µ—Ç—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å—Å—è

**–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã:**
- ‚ùì –í—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –º–µ–∂–¥—É callback –∏ text –≤ –ª–æ–≥–∞—Ö
- ‚ùì –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π

### **–ì–∏–ø–æ—Ç–µ–∑–∞ 4: –ö–æ–Ω—Ñ–ª–∏–∫—Ç –∏–º–ø–æ—Ä—Ç–æ–≤ —Å–æ—Å—Ç–æ—è–Ω–∏–π**
**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ—Å—Ç–æ—è–Ω–∏—è `AgendaStates` –º–æ–≥—É—Ç –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø–æ-—Ä–∞–∑–Ω–æ–º—É –≤ —Ä–∞–∑–Ω—ã—Ö –º–æ–¥—É–ª—è—Ö.

**–ê–Ω–∞–ª–∏–∑:**
```python
# –í handlers.py:
from app.bot.handlers_agenda import AgendaStates

# –í handlers_agenda.py:
class AgendaStates(StatesGroup):  # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

# –í tests:
from app.bot.handlers_agenda import AgendaStates
```

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- –†–∞–∑–Ω—ã–µ –∏–Ω—Å—Ç–∞–Ω—Å—ã –∫–ª–∞—Å—Å–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π
- –ü—Ä–æ–±–ª–µ–º—ã —Å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–π
- Circular imports

### **–ì–∏–ø–æ—Ç–µ–∑–∞ 5: aiogram middleware –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ**
**–û–ø–∏—Å–∞–Ω–∏–µ:** Middleware –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å –∏–ª–∏ —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è.

**–ê–Ω–∞–ª–∏–∑:**
```python
# –í–æ–∑–º–æ–∂–Ω—ã–µ middleware:
- Logging middleware
- Error handling middleware  
- Rate limiting middleware
- Custom middleware –≤ –ø—Ä–æ–µ–∫—Ç–µ
```

### **–ì–∏–ø–æ—Ç–µ–∑–∞ 6: –ü—Ä–æ–±–ª–µ–º–∞ —Å —Ñ–∏–ª—å—Ç—Ä–æ–º F.text**
**–û–ø–∏—Å–∞–Ω–∏–µ:** –§–∏–ª—å—Ç—Ä `F.text` –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –¥–æ–ª–∂–Ω—ã–º –æ–±—Ä–∞–∑–æ–º —Å —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏.

**–ê–Ω–∞–ª–∏–∑:**
```python
# –ú–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º–∞:
@router.message(AgendaStates.waiting_person_name, F.text)

# –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã:
@router.message(AgendaStates.waiting_person_name)
@router.message(F.text, AgendaStates.waiting_person_name)
```

## üß™ –ú–µ—Ç–æ–¥—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### **1. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π**
```python
# –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–∞–∂–¥—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫:
current_state = await state.get_state()
logger.info(f"Handler {handler_name}: state={current_state}, text='{message.text}'")
```

### **2. –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**
```python
# –î–æ–±–∞–≤–∏—Ç—å –≤ –Ω–∞—á–∞–ª–æ –∫–∞–∂–¥–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞:
import traceback
logger.info(f"Handler call stack: {traceback.format_stack()[-3:]}")
```

### **3. –ü—Ä–æ–≤–µ—Ä–∫–∞ storage —Å–æ—Å—Ç–æ—è–Ω–∏—è**
```python
# –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É storage:
storage_data = await state.storage.get_data(bot=bot, chat=message.chat.id, user=message.from_user.id)
logger.info(f"Storage data: {storage_data}")
```

### **4. –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç —Å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–º storage**
```python
# –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å Redis –≤–º–µ—Å—Ç–æ Memory:
from aiogram.fsm.storage.redis import RedisStorage
storage = RedisStorage.from_url("redis://localhost:6379/0")
```

### **5. –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º—ã–π –ø—Ä–∏–º–µ—Ä**
```python
# –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –±–æ—Ç —Ç–æ–ª—å–∫–æ —Å agenda:
- –£–±—Ä–∞—Ç—å –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–æ—É—Ç–µ—Ä—ã
- –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ agenda_router –∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π main router
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ FSM –≤ –∏–∑–æ–ª—è—Ü–∏–∏
```

## üéØ –í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ—à–µ–Ω–∏—è

### **–†–µ—à–µ–Ω–∏–µ 1: Middleware-based FSM routing**
```python
# –°–æ–∑–¥–∞—Ç—å middleware –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
# –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–µ—Ä–µ–¥ —Ä–æ—É—Ç–∏–Ω–≥–æ–º
class FSMRoutingMiddleware:
    async def __call__(self, handler, event, data):
        if isinstance(event, Message) and event.text:
            state = data.get('state')
            if state:
                current_state = await state.get_state()
                # –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
```

### **–†–µ—à–µ–Ω–∏–µ 2: Single router approach**
```python
# –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤—Å–µ FSM –ª–æ–≥–∏–∫—É –≤ –æ–¥–∏–Ω —Ä–æ—É—Ç–µ—Ä
# –£–±—Ä–∞—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ñ–∞–π–ª–∞–º
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–∏–Ω –±–æ–ª—å—à–æ–π handlers.py —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏
```

### **–†–µ—à–µ–Ω–∏–µ 3: State-specific handlers**
```python
# –°–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
@router.message(lambda msg: msg.text and not msg.text.startswith("/"))
async def universal_text_handler(message: Message, state: FSMContext):
    # –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º
```

### **–†–µ—à–µ–Ω–∏–µ 4: Command-based approach**
```python
# –ò–∑–º–µ–Ω–∏—Ç—å UX - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã –≤–º–µ—Å—Ç–æ FSM
# /agenda_person Valya Dobrynin
# /agenda_meeting 123-456-789
# /agenda_tag Finance/IFRS
```

### **–†–µ—à–µ–Ω–∏–µ 5: Callback-only approach**
```python
# –£–±—Ä–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥ –ø–æ–ª–Ω–æ—Å—Ç—å—é
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ inline –∫–Ω–æ–ø–∫–∏ —Å –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏
# –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–î—Ä—É–≥–æ–π —á–µ–ª–æ–≤–µ–∫" ‚Üí –Ω–æ–≤–æ–µ –º–µ–Ω—é —Å –∫–Ω–æ–ø–∫–∞–º–∏
```

## üìä –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ä–µ—à–µ–Ω–∏–π

| –†–µ—à–µ–Ω–∏–µ | –°–ª–æ–∂–Ω–æ—Å—Ç—å | –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å | UX | –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å |
|---------|-----------|------------|-----|---------------|
| Middleware | –í—ã—Å–æ–∫–∞—è | –í—ã—Å–æ–∫–∞—è | –•–æ—Ä–æ—à–∞—è | –¢—Ä–µ–±—É–µ—Ç —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ |
| Single router | –°—Ä–µ–¥–Ω—è—è | –í—ã—Å–æ–∫–∞—è | –•–æ—Ä–æ—à–∞—è | –¢—Ä–µ–±—É–µ—Ç —Ä–µ–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é |
| State handlers | –°—Ä–µ–¥–Ω—è—è | –°—Ä–µ–¥–Ω—è—è | –•–æ—Ä–æ—à–∞—è | –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è |
| Commands | –ù–∏–∑–∫–∞—è | –í—ã—Å–æ–∫–∞—è | –°—Ä–µ–¥–Ω—è—è | –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è |
| Callbacks only | –ù–∏–∑–∫–∞—è | –í—ã—Å–æ–∫–∞—è | –°—Ä–µ–¥–Ω—è—è | –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è |

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### **–ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–±—ã—Å—Ç—Ä–æ–µ):**
**–†–µ—à–µ–Ω–∏–µ 4: Command-based approach**
- –ó–∞–º–µ–Ω–∏—Ç—å FSM –Ω–∞ –∫–æ–º–∞–Ω–¥—ã: `/agenda_person Valya Dobrynin`
- –ü—Ä–æ—Å—Ç–æ–µ, –Ω–∞–¥–µ–∂–Ω–æ–µ, –±—ã—Å—Ç—Ä–æ —Ä–µ–∞–ª–∏–∑—É–µ–º–æ–µ
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ

### **–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ):**
**–†–µ—à–µ–Ω–∏–µ 1: Middleware-based FSM routing**
- –°–æ–∑–¥–∞—Ç—å middleware –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ FSM
- –†–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É —Å–∏—Å—Ç–µ–º–Ω–æ –¥–ª—è –≤—Å–µ—Ö FSM —Å–æ—Å—Ç–æ—è–Ω–∏–π
- –¢—Ä–µ–±—É–µ—Ç –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏, –Ω–æ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –Ω–∞–≤—Å–µ–≥–¥–∞

### **–ö–æ–º–ø—Ä–æ–º–∏—Å—Å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**
**–†–µ—à–µ–Ω–∏–µ 5: Callback-only approach**
- –£–±—Ä–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥, –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∏
- –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–î—Ä—É–≥–æ–π —á–µ–ª–æ–≤–µ–∫" —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º –º–µ–Ω—é
- UX –Ω–µ–º–Ω–æ–≥–æ —Ö—É–∂–µ, –Ω–æ 100% –Ω–∞–¥–µ–∂–Ω–æ

## üîç –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

1. **–í–∫–ª—é—á–∏—Ç—å DEBUG –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –≤—Å–µ—Ö FSM –æ–ø–µ—Ä–∞—Ü–∏–π
2. **–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫—É** –≤—ã–∑–æ–≤–æ–≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å timing** –º–µ–∂–¥—É callback –∏ text message
4. **–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç —Å –∏–∑–æ–ª—è—Ü–∏–µ–π** - —É–±—Ä–∞—Ç—å –≤—Å–µ —Ä–æ—É—Ç–µ—Ä—ã –∫—Ä–æ–º–µ agenda
5. **–¢–µ—Å—Ç —Å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–º storage** (Redis –≤–º–µ—Å—Ç–æ Memory)

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–ü—Ä–æ–±–ª–µ–º–∞ —Å–ª–æ–∂–Ω–µ–µ —á–µ–º –∫–∞–∑–∞–ª–æ—Å—å –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ.** –≠—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤, –∞ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã FSM –≤ –º–Ω–æ–≥–æ—Ä–æ—É—Ç–µ—Ä–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ aiogram.

**–¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∏–Ω—Ü–∏–ø–∏–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**
- –õ–∏–±–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ UX (–∫–æ–º–∞–Ω–¥—ã/–∫–Ω–æ–ø–∫–∏)
- –õ–∏–±–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ (middleware/single router)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ù–∞—á–∞—Ç—å —Å **command-based approach** –∫–∞–∫ –±—ã—Å—Ç—Ä–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è, –∞ –∑–∞—Ç–µ–º —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å middleware –¥–ª—è –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–π –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã.

---

*–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞: 29 —Å–µ–Ω—Ç—è–±—Ä—è 2025*  
*–°—Ç–∞—Ç—É—Å: üîç –ì–õ–£–ë–ò–ù–ù–´–ô –ê–ù–ê–õ–ò–ó –ó–ê–í–ï–†–®–ï–ù*  
*–¢—Ä–µ–±—É–µ—Ç—Å—è: üéØ –ü–†–ò–ù–Ø–¢–ò–ï –†–ï–®–ï–ù–ò–Ø –û –ü–û–î–•–û–î–ï*

