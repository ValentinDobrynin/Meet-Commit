# 🔄 Синхронизация с Notion Tag Catalog

## Обзор

Система синхронизации правил тегирования с Notion Tag Catalog обеспечивает централизованное управление правилами тегирования через Notion с автоматическим fallback на локальные YAML файлы.

## 🎯 Зачем это нужно

### Проблемы текущего подхода
- **Ручное обновление** - правила в YAML требуют деплоя для изменения
- **Нет централизации** - правила разбросаны по файлам
- **Отсутствие истории** - нет логов изменений правил
- **Сложность управления** - требуются технические знания

### Преимущества Notion синхронизации
- **✅ Централизованное управление** - все правила в одном месте
- **✅ Живое редактирование** - изменения без деплоя
- **✅ История изменений** - встроенный лог Notion
- **✅ Удобный интерфейс** - редактирование через UI
- **✅ Надежность** - автоматический fallback на YAML

## 🏗️ Архитектура

### Гибридная система источников

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│  Notion Tag     │    │   Local Cache    │    │   YAML File     │
│   Catalog       │───▶│  (cache/*.json)  │───▶│ (data/*.yaml)   │
│  (Primary)      │    │   (Fast start)   │    │   (Fallback)    │
└─────────────────┘    └──────────────────┘    └─────────────────┘
         │                        │                        │
         ▼                        ▼                        ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Tagger v1 Scored                            │
│                   (Runtime Rules)                              │
└─────────────────────────────────────────────────────────────────┘
```

### Приоритет источников

1. **🥇 Notion Tag Catalog** - если доступен и настроен
2. **🥈 Local YAML** - если Notion недоступен
3. **🥉 Cache** - для быстрого старта

## ⚙️ Настройка

### 1. Создание баз в Notion

#### Tag Catalog Database

**Обязательные поля:**
- **Name** (Title) - название тега (например: "IFRS")
- **Kind** (Select) - категория: Finance, Business, People, Projects, Topic, Area
- **Pattern(s)** (Rich Text) - паттерны поиска (по одному на строку)
- **Weight** (Number) - вес тега (по умолчанию: 1.0)
- **Active** (Checkbox) - активность правила

**Опциональные поля:**
- **Exclude** (Rich Text) - исключающие паттерны
- **Description** (Rich Text) - описание правила
- **Created** (Created time) - время создания
- **Last edited** (Last edited time) - последнее изменение

#### Пример записи в Tag Catalog:

| Name | Kind | Pattern(s) | Exclude | Weight | Active |
|------|------|------------|---------|--------|--------|
| IFRS | Finance | ifrs<br>reporting<br>financial standards | email<br>spam | 2.0 | ☑️ |
| Lavka | Business | lavka<br>лавка<br>marketplace | | 1.5 | ☑️ |

### 2. Настройка переменных окружения

```bash
# .env
# Основные настройки Notion
NOTION_TOKEN=secret_your-notion-integration-token
NOTION_DB_MEETINGS_ID=your-meetings-database-id

# Новые базы для синхронизации
NOTION_DB_TAG_CATALOG_ID=your-tag-catalog-database-id
NOTION_DB_PROJECT_CATALOG_ID=your-project-catalog-database-id

# Настройки синхронизации
APP_NOTION_SYNC_ENABLED=true
APP_NOTION_SYNC_INTERVAL_HOURS=24
APP_NOTION_SYNC_FALLBACK_TO_YAML=true
```

### 3. Настройка прав доступа

1. **Добавьте интеграцию** к новым базам данных
2. **Предоставьте права** на чтение для Tag Catalog
3. **Проверьте доступ** через команду `/sync_status`

## 🎮 Использование

### Административные команды

#### `/sync_tags` - Синхронизация правил
```
/sync_tags
```

**Результат:**
```
✅ Синхронизация завершена

📊 Источник: notion
🏷️ Правил загружено: 45
📋 По категориям: Business=15, Finance=12, People=10, Projects=8
💾 Кэш обновлен
🎯 Правила активны в тэггере
```

#### `/sync_tags dry-run` - Проверка без применения
```
/sync_tags dry-run
```

**Результат:**
```
✅ Синхронизация проверена

📊 Источник: notion
🏷️ Правил загружено: 45
📋 По категориям: Business=15, Finance=12, People=10, Projects=8

💡 Для применения запустите без dry-run
```

#### `/sync_status` - Статус синхронизации
```
/sync_status
```

**Результат:**
```
📊 Статус синхронизации Tag Catalog

🕐 Последняя синхронизация: 2025-09-22 15:30:00
⏱️ Прошло времени: 2.5 часов
📍 Источник: notion
✅ Статус: success
🏷️ Правил загружено: 45
📋 По категориям: Business=15, Finance=12, People=10, Projects=8

🔗 Notion Tag Catalog:
   ✅ Доступен
   📝 Название: Tag Catalog
   🔧 Поля: 6

💾 Локальный кэш: ✅ доступен
```

### Автоматическая синхронизация

При настройке `APP_NOTION_SYNC_INTERVAL_HOURS=24` система будет автоматически синхронизироваться каждые 24 часа.

## 🛠️ Управление правилами в Notion

### Добавление нового правила

1. **Откройте Tag Catalog** в Notion
2. **Создайте новую запись:**
   - **Name:** GDPR
   - **Kind:** Finance
   - **Pattern(s):** 
     ```
     gdpr
     general data protection
     персональные данные
     ```
   - **Weight:** 1.5
   - **Active:** ☑️

3. **Выполните синхронизацию:** `/sync_tags`

### Отключение правила

1. **Найдите правило** в Tag Catalog
2. **Снимите галочку Active**
3. **Выполните синхронизацию:** `/sync_tags`

### Изменение веса или паттернов

1. **Отредактируйте поля** в Notion
2. **Сохраните изменения**
3. **Выполните синхронизацию:** `/sync_tags`

## 🔒 Безопасность и надежность

### Система fallback

**При недоступности Notion:**
1. Система автоматически переключается на YAML
2. Показывает предупреждение в логах
3. Продолжает работу без прерываний

**При ошибках в правилах:**
- Некорректные regex игнорируются с логированием
- Неполные записи пропускаются
- Система не падает при единичных ошибках

### Кэширование

**Локальный кэш (`cache/tag_rules.json`):**
- Сохраняется при каждой успешной синхронизации
- Используется для быстрого старта бота
- Обновляется автоматически

**Метаданные (`cache/sync_metadata.json`):**
- Время последней синхронизации
- Источник правил
- Статистика по категориям
- Информация об ошибках

## 📊 Мониторинг

### Логирование

**Ключевые события:**
```bash
# Успешная синхронизация
grep "Tag rules synced" logs/bot.log

# Ошибки синхронизации  
grep "Failed to sync" logs/bot.log

# Fallback на YAML
grep "Falling back to YAML" logs/bot.log
```

### Метрики

**Статистика синхронизации:**
- Время последней синхронизации
- Количество правил по категориям
- Источник данных (notion/yaml/cache)
- Частота ошибок

## 🚨 Устранение неполадок

### Проблема: "Tag Catalog not accessible"

**Причины:**
1. Неправильный `NOTION_DB_TAG_CATALOG_ID`
2. Отсутствие прав доступа к базе
3. Неактивная интеграция Notion

**Решение:**
1. Проверьте ID базы в Notion
2. Добавьте интеграцию к базе
3. Проверьте токен: `/admin_config`

### Проблема: "No active rules found"

**Причины:**
1. Все правила отключены (Active = false)
2. База пуста
3. Неправильная структура базы

**Решение:**
1. Проверьте галочки Active в базе
2. Добавьте хотя бы одно правило
3. Проверьте структуру полей

### Проблема: Синхронизация работает, но теги не находятся

**Причины:**
1. Неправильные regex паттерны
2. Слишком высокий порог score
3. Конфликты с exclude паттернами

**Решение:**
1. Проверьте паттерны: `/test_tags <текст>`
2. Снизьте `tags_min_score`
3. Проверьте exclude правила

## 🔧 Техническая информация

### API интеграция

**Используемые Notion API:**
- `POST /databases/{id}/query` - загрузка правил
- `GET /databases/{id}` - проверка доступа
- Фильтрация по `Active = true`
- Сортировка по `Kind` и `Name`

### Формат данных

**Notion → Tagger конвертация:**
```json
// Notion format
{
  "tag": "Finance/IFRS",
  "patterns": ["ifrs", "reporting"],
  "exclude": ["email"],
  "weight": 2.0
}

// Tagger format  
{
  "Finance/IFRS": {
    "patterns": ["ifrs", "reporting"],
    "exclude": ["email"],
    "weight": 2.0
  }
}
```

### Производительность

**Оптимизации:**
- Кэширование правил для быстрого старта
- Batch загрузка из Notion
- Компиляция regex только при изменениях
- Асинхронная синхронизация

**Ограничения:**
- Максимум 100 правил за запрос к Notion
- Время синхронизации: 5-15 секунд
- Интервал автосинхронизации: минимум 1 час

## 📋 Примеры использования

### Пример 1: Первоначальная настройка

1. **Создайте Tag Catalog в Notion**
2. **Добавьте несколько правил:**
   ```
   Name: IFRS | Kind: Finance | Pattern(s): ifrs\nreporting | Weight: 2.0 | Active: ✓
   Name: Lavka | Kind: Business | Pattern(s): lavka\nлавка | Weight: 1.5 | Active: ✓
   ```
3. **Настройте .env:**
   ```bash
   NOTION_DB_TAG_CATALOG_ID=your-database-id
   APP_NOTION_SYNC_ENABLED=true
   ```
4. **Выполните синхронизацию:** `/sync_tags`

### Пример 2: Добавление нового правила

1. **В Notion добавьте запись:**
   ```
   Name: Mobile App
   Kind: Projects
   Pattern(s): mobile\napp\nприложение
   Weight: 1.0
   Active: ✓
   ```
2. **Синхронизируйте:** `/sync_tags`
3. **Проверьте:** `/test_tags Обсуждали мобильное приложение`

### Пример 3: Отключение устаревшего правила

1. **Найдите правило** в Tag Catalog
2. **Снимите галочку Active**
3. **Синхронизируйте:** `/sync_tags`
4. **Проверьте статус:** `/sync_status`

## 🔮 Будущие возможности

### Планируемые функции
- **🤖 Автосинхронизация** - по расписанию без команд
- **📊 Аналитика правил** - статистика использования
- **🔄 Двусторонняя синхронизация** - экспорт в Notion
- **📝 Tag Edits база** - история изменений тегов

### Расширения
- **🎨 Кастомные категории** - новые типы тегов
- **🔍 Поиск правил** - быстрый поиск в каталоге
- **📈 A/B тестирование** - тестирование новых правил

## 🧪 Тестирование

### Проверка настроек

```bash
# Проверьте переменные окружения
echo $NOTION_DB_TAG_CATALOG_ID

# Проверьте статус в боте
/sync_status
```

### Тестирование синхронизации

```bash
# Dry-run проверка
/sync_tags dry-run

# Полная синхронизация
/sync_tags

# Проверка результата
/tags_stats
```

### Валидация правил

```bash
# Проверка корректности правил
/tags_validate

# Тестирование конкретного текста
/test_tags Обсуждали IFRS и финансовую отчетность
```

## 📚 Связанная документация

- [Система тегирования](tagging_system.md) - основы работы тегов
- [Техническая документация тегирования](tagger_v1_scored.md) - детали реализации
- [Контроль доступа](admin_access_control.md) - система безопасности
- [Настройка админского доступа](setup_admin_access.md) - первоначальная настройка

## 💡 Рекомендации

### Для администраторов

1. **Начните с малого** - добавьте 5-10 основных правил
2. **Тестируйте изменения** - используйте dry-run
3. **Мониторьте логи** - следите за ошибками синхронизации
4. **Делайте резервные копии** - экспортируйте базу периодически

### Для разработчиков

1. **Используйте fallback** - всегда поддерживайте YAML актуальным
2. **Логируйте ошибки** - добавляйте детальное логирование
3. **Тестируйте offline** - проверяйте работу без Notion
4. **Мониторьте производительность** - следите за временем синхронизации

### Лучшие практики

1. **Регулярная синхронизация** - не реже раза в день
2. **Валидация правил** - проверяйте regex перед добавлением
3. **Документирование изменений** - используйте Description поле
4. **Постепенные изменения** - не меняйте много правил сразу
