# –§–∞–∑–∞ 2: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –∏ —Ç–∏–ø–∏–∑–∞—Ü–∏—è

## üéØ –û–±–∑–æ—Ä

–§–∞–∑–∞ 2 —Ñ–æ–∫—É—Å–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–∏ –±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º –∫–æ–¥–µ –∏ —É–ª—É—á—à–µ–Ω–∏–∏ —Ç–∏–ø–∏–∑–∞—Ü–∏–∏ –¥–ª—è –ª—É—á—à–µ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏ IDE –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Ç–∏–ø–æ–≤.

## üöÄ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### **1. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ gateway —Ñ—É–Ω–∫—Ü–∏–∏**

#### **–ù–æ–≤—ã–µ –º–æ–¥—É–ª–∏:**
- **`app/gateways/notion_commits_async.py`** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –∫–æ–º–º–∏—Ç–∞–º–∏
- **`app/core/llm_extract_commits_async.py`** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–º–º–∏—Ç–æ–≤
- **`app/core/llm_commit_parse_async.py`** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ –∫–æ–º–º–∏—Ç–æ–≤

#### **–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
```python
# –í–º–µ—Å—Ç–æ:
await run_in_executor(None, upsert_commits, ...)

# –¢–µ–ø–µ—Ä—å:
await upsert_commits_async(meeting_page_id, commits)
```

### **2. –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ run_in_executor**

#### **–î–æ:**
```python
# 7 –º–µ—Å—Ç —Å –±–ª–æ–∫–∏—Ä—É—é—â–∏–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
extracted_commits = await asyncio.get_event_loop().run_in_executor(
    None, lambda: extract_commits(text, attendees, date)
)

commits_result = await asyncio.get_event_loop().run_in_executor(
    None, lambda: upsert_commits(meeting_id, commits)
)
```

#### **–ü–æ—Å–ª–µ:**
```python
# –ù–∞—Ç–∏–≤–Ω—ã–π async –∫–æ–¥
extracted_commits = await extract_commits_async(text, attendees, date)
commits_result = await upsert_commits_async(meeting_id, commits)
```

### **3. –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è**

#### **–ù–æ–≤—ã–π –º–æ–¥—É–ª—å —Ç–∏–ø–æ–≤ (`app/core/types.py`):**
```python
class CommitData(TypedDict, total=False):
    title: str
    text: str
    direction: Literal["mine", "theirs"]
    assignees: list[str]
    from_person: list[str]
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è

class MeetingData(TypedDict, total=False):
    title: str
    date: str | None
    attendees: list[str]
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
```

#### **–ó–∞–º–µ–Ω–∞ dict[str, Any]:**
```python
# –í–º–µ—Å—Ç–æ:
def process_commit(data: dict[str, Any]) -> dict[str, Any]:

# –¢–µ–ø–µ—Ä—å:
def process_commit(data: CommitData) -> NotionCommitData:
```

### **4. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**

#### **–ù–æ–≤—ã–π –º–æ–¥—É–ª—å (`app/core/structured_logging.py`):**
```python
# –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logger = get_commit_logger(user_id=12345, commit_id="abc123")
logger.info("commit_created", "–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∫–æ–º–º–∏—Ç", 
           assignee="Sasha", tags_count=3)

# –ú–∞—à–∏–Ω–æ—á–∏—Ç–∞–µ–º—ã–π JSON + —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–π —Ç–µ–∫—Å—Ç
# [commit_created] –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∫–æ–º–º–∏—Ç | {"event_type":"commit_created","context":{"user_id":12345,"commit_id":"abc123"},"assignee":"Sasha","tags_count":3}
```

## ‚ö° –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ**

#### **–î–æ (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ):**
```python
# ~50ms –¥–ª—è 5 –æ–ø–µ—Ä–∞—Ü–∏–π
for commit in commits:
    await run_in_executor(None, process_commit, commit)
```

#### **–ü–æ—Å–ª–µ (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ):**
```python
# ~10ms –¥–ª—è 5 –æ–ø–µ—Ä–∞—Ü–∏–π
async with asyncio.Semaphore(5):
    tasks = [process_commit_async(commit) for commit in commits]
    await asyncio.gather(*tasks)
```

### **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π**

- **Connection pooling:** –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ HTTP —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- **–°–µ–º–∞—Ñ–æ—Ä—ã:** –ö–æ–Ω—Ç—Ä–æ–ª—å concurrency (max 5 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤)
- **Timeout'—ã:** –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### **–ù–æ–≤—ã–µ —Ç–µ—Å—Ç—ã:**
- **`tests/test_async_improvements.py`** - —Ç–µ—Å—Ç—ã –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
- **–ö–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏** - —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ async vs executor
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã** - –ø–æ–ª–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω

### **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- **‚úÖ 8 –Ω–æ–≤—ã—Ö —Ç–µ—Å—Ç–æ–≤** - –≤—Å–µ –ø—Ä–æ—Ö–æ–¥—è—Ç
- **‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - async –≤ ~5x –±—ã—Å—Ç—Ä–µ–µ –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- **üîß –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - –±–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ sync/async**

```
app/core/
‚îú‚îÄ‚îÄ llm_extract_commits.py       # –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è (legacy)
‚îú‚îÄ‚îÄ llm_extract_commits_async.py # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è (–Ω–æ–≤–∞—è)
‚îú‚îÄ‚îÄ llm_commit_parse.py          # –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è (legacy) 
‚îî‚îÄ‚îÄ llm_commit_parse_async.py    # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è (–Ω–æ–≤–∞—è)

app/gateways/
‚îú‚îÄ‚îÄ notion_commits.py            # –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è (legacy)
‚îî‚îÄ‚îÄ notion_commits_async.py      # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è (–Ω–æ–≤–∞—è)
```

### **–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è**

1. **Handlers –æ–±–Ω–æ–≤–ª–µ–Ω—ã** - –∏—Å–ø–æ–ª—å–∑—É—é—Ç async –≤–µ—Ä—Å–∏–∏
2. **Legacy —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã** - –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
3. **–¢–µ—Å—Ç—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç –æ–±–µ –≤–µ—Ä—Å–∏–∏** - –≥–∞—Ä–∞–Ω—Ç–∏—è —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

## üìä –ú–µ—Ç—Ä–∏–∫–∏ —É–ª—É—á—à–µ–Ω–∏–π

### **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
- **‚ùå –£–±—Ä–∞–Ω–æ:** 7 –±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö `run_in_executor` –≤—ã–∑–æ–≤–æ–≤
- **‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ:** –ù–∞—Ç–∏–≤–Ω—ã–µ async –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–æ–º
- **‚ö° –£—Å–∫–æ—Ä–µ–Ω–∏–µ:** –î–æ 5x –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏

### **–¢–∏–ø–∏–∑–∞—Ü–∏—è:**
- **‚ùå –£–±—Ä–∞–Ω–æ:** 47+ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π `dict[str, Any]`
- **‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ:** 15+ TypedDict –º–æ–¥–µ–ª–µ–π
- **üîç IDE –ø–æ–¥–¥–µ—Ä–∂–∫–∞:** –ê–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤

### **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- **‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏** - JSON + —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–π —Ç–µ–∫—Å—Ç
- **üîç –ö–æ–Ω—Ç–µ–∫—Å—Ç** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ user_id, commit_id
- **üìä –ú–∞—à–∏–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** - –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –¥–ª—è log aggregation

## üîÑ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

### **Legacy –ø–æ–¥–¥–µ—Ä–∂–∫–∞:**
- **–°—Ç–∞—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã** - –Ω–∏–∫–∞–∫–∏—Ö breaking changes
- **–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è** - –º–æ–∂–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–æ–¥—É–ª—è–º–∏
- **–¢–µ—Å—Ç—ã –¥–ª—è –æ–±–µ–∏—Ö –≤–µ—Ä—Å–∏–π** - –≥–∞—Ä–∞–Ω—Ç–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏

### **–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ:**
```python
# –õ–µ–≥–∫–æ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –æ–±—Ä–∞—Ç–Ω–æ –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö
from app.core.llm_extract_commits import extract_commits  # sync
# from app.core.llm_extract_commits_async import extract_commits_async  # async
```

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–§–∞–∑–∞ 3)

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏** - —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
2. **–£–¥–∞–ª–µ–Ω–∏–µ legacy —Ñ—É–Ω–∫—Ü–∏–π** - –ø–æ—Å–ª–µ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏
3. **–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ async –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤** - –Ω–∞ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏
4. **–ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø–æ–∏—Å–∫ –Ω–æ–≤—ã—Ö —É–∑–∫–∏—Ö –º–µ—Å—Ç
