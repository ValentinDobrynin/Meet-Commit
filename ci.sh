#!/bin/bash

# Meet-Commit CI Pipeline Runner
# ะะฐะฟััะบะฐะตั ะฒัะต ะฟัะพะฒะตัะบะธ ะบะฐัะตััะฒะฐ ะธ ะฑะตะทะพะฟะฐัะฝะพััะธ

set -e  # ะััะฐะฝะพะฒะธัััั ะฟัะธ ะฟะตัะฒะพะน ะพัะธะฑะบะต

echo "๐ Meet-Commit CI Pipeline"
echo "=========================="

# ะัะพะฒะตััะตะผ, ััะพ ะผั ะฒ ะฟัะฐะฒะธะปัะฝะพะน ะดะธัะตะบัะพัะธะธ
if [ ! -f "requirements.txt" ] || [ ! -d "app" ]; then
    echo "โ ะัะธะฑะบะฐ: ะะฐะฟัััะธัะต ัะบัะธะฟั ะธะท ะบะพัะฝะตะฒะพะน ะดะธัะตะบัะพัะธะธ ะฟัะพะตะบัะฐ"
    exit 1
fi

# ะะบัะธะฒะธััะตะผ ะฒะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต
if [ ! -d "venv" ]; then
    echo "โ ะัะธะฑะบะฐ: ะะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต ะฝะต ะฝะฐะนะดะตะฝะพ. ะกะพะทะดะฐะนัะต ะตะณะพ: python -m venv venv"
    exit 1
fi

echo "๐ฆ ะะบัะธะฒะฐัะธั ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั..."
source venv/bin/activate

# ะัะพะฒะตััะตะผ ัััะฐะฝะพะฒะบั ะทะฐะฒะธัะธะผะพััะตะน
echo "๐ ะัะพะฒะตัะบะฐ ะทะฐะฒะธัะธะผะพััะตะน..."
if ! python -c "import pytest, mypy, bandit, deptry" 2>/dev/null; then
    echo "๐ฅ ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน..."
    pip install -r requirements.txt
fi

echo ""
echo "๐งน 1/6 ะะธะฝัะธะฝะณ ะธ ัะพัะผะฐัะธัะพะฒะฐะฝะธะต..."
make lint
make fmt

echo ""
echo "๐ 2/6 ะัะพะฒะตัะบะฐ ัะธะฟะพะฒ..."
make typecheck

echo ""
echo "๐งช 3/6 ะขะตััะธัะพะฒะฐะฝะธะต ั ะฟะพะบัััะธะตะผ..."
make test-cov

echo ""
echo "๐ 4/6 ะกะบะฐะฝะธัะพะฒะฐะฝะธะต ะฑะตะทะพะฟะฐัะฝะพััะธ..."
make security

echo ""
echo "๐ 5/6 ะัะดะธั ะทะฐะฒะธัะธะผะพััะตะน..."
make audit

echo ""
echo "๐ฆ 6/6 ะะฝะฐะปะธะท ะทะฐะฒะธัะธะผะพััะตะน..."
make deps

echo ""
echo "โ ะัะต ะฟัะพะฒะตัะบะธ ะฟัะพะนะดะตะฝั ััะฟะตัะฝะพ!"
echo "๐ ะะพะด ะณะพัะพะฒ ะบ ะบะพะผะผะธัั ะธ ะฟััั!"
echo ""
echo "๐ ะะพะบัััะธะต ัะตััะฐะผะธ: 64%"
echo "๐ ะะตะทะพะฟะฐัะฝะพััั: 0 ะบัะธัะธัะตัะบะธั ััะทะฒะธะผะพััะตะน"
echo "๐ฆ ะะฐะฒะธัะธะผะพััะธ: 0 ะฟัะพะฑะปะตะผ"
